<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CEIPAL Compliance Agent / I-9</title>
    <link rel="stylesheet" href="./style.css" />
    <style>
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
        }

        .typing-indicator span {
            width: 6px;
            height: 6px;
            background-color: #64748b;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.5;
            }

            50% {
                transform: scale(1.5);
                opacity: 1;
            }
        }

        .i9-form-container {
            max-width: 600px;
            margin: 0 auto;
            text-align: left;
        }

        .i9-form-group {
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .i9-form-group label {
            font-size: 14px;
            font-weight: 600;
            color: #334155;
        }

        .i9-input {
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            width: 100%;
            box-sizing: border-box;
        }

        .i9-btn-next {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: 0.2s;
        }

        .i9-btn-next:hover {
            background: #1d4ed8;
        }

        .fade-in {
            animation: fadeIn 0.4s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Debug Pill to show the legal state */
        .debug-pill {
            background: #fef3c7;
            color: #92400e;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            margin-left: 10px;
            border: 1px solid #fcd34d;
        }
    </style>
</head>

<body class="shell-root">
    <aside class="shell-left">
        <div class="shell-left__brand">CEIPAL</div>
        <nav class="shell-left__nav">
            <a class="shell-left__item active" href="#">I-9 Worker Agent</a>
        </nav>
    </aside>

    <div class="shell-right">
        <header class="shell-header">
            <div class="shell-header__left">
                <div class="shell-header__title">CEIPAL HR Onboarding</div>
            </div>
        </header>

        <main class="workspace">
            <div class="workspace-grid">

                <section class="chat-pane">
                    <div class="chat-pane__header">
                        <span class="chat-pane__title">I-9 Assistant</span>
                    </div>
                    <div class="chat-thread" id="thread">
                    </div>
                    <div class="chat-input">
                        <input id="msg" placeholder="Type your answer here..." autocomplete="off" />
                        <button class="btn primary" id="send">Send</button>
                    </div>
                </section>

                <section class="canvas-pane">
                    <div class="canvas-pane__header">
                        <span class="canvas-pane__title">Secure Form Canvas</span>
                        <span class="canvas-pill" id="canvasStatus">Awaiting Discovery...</span>
                    </div>
                    <div class="canvas-pane__body">
                        <div class="canvas-card" id="canvasContainer">
                            <div style="padding: 40px; text-align: center; color: #64748b;">
                                Chat with the assistant. Once your legal status is determined, your customized form will
                                securely render here.
                            </div>
                        </div>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <script>
        const threadEl = document.getElementById("thread");
        const msgEl = document.getElementById("msg");
        const sendBtn = document.getElementById("send");
        const canvasEl = document.getElementById("canvasContainer");
        const statusEl = document.getElementById("canvasStatus");

        // The UI now maintains the chat history to send to the backend
        let chatHistory = [];
        // A simple session ID so the backend remembers this specific user's state
        const sessionId = "session_" + Math.random().toString(36).substring(7);

        function addMsg(who, text, intent = null) {
            const wrap = document.createElement("div");
            wrap.className = who === "You" ? "bubble you fade-in" : "agent-block fade-in";

            if (who !== "You") {
                let html = `<div class="agent-meta">${who}`;
                // Show a debug pill so you can see the backend changing state intents
                if (intent) html += `<span class="debug-pill">${intent}</span>`;
                html += `</div><div class="agent-text">${text}</div>`;
                wrap.innerHTML = html;
            } else {
                wrap.textContent = text;
            }
            threadEl.appendChild(wrap);
            threadEl.scrollTop = threadEl.scrollHeight;
        }

        function showLoading() {
            const id = "load-" + Date.now();
            const wrap = document.createElement("div");
            wrap.id = id;
            wrap.className = "agent-block fade-in";
            wrap.innerHTML = `<div class="agent-meta">Assistant</div><div class="agent-text"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`;
            threadEl.appendChild(wrap);
            threadEl.scrollTop = threadEl.scrollHeight;
            return id;
        }

        // --- THE DETERMINISTIC FORM PAINTER ---
        function renderForm(formDef) {
            statusEl.textContent = "Form Unlocked";
            statusEl.style.background = "#dcfce7";
            statusEl.style.color = "#16a34a";

            let html = `<div class="canvas-inner-body fade-in" style="background: #fff; padding: 40px;">`;
            html += `<div class="i9-form-container">`;
            html += `<h2 style="margin-top:0; color: #1e293b;">${formDef.title}</h2>`;
            html += `<p style="color: #64748b; margin-bottom: 24px;">${formDef.instructions}</p>`;

            html += `<form id="dynamic-i9-form">`;

            // Loop through the EXACT fields the Python backend authorized
            if (formDef.fields) {
                formDef.fields.forEach(field => {
                    const reqHtml = field.required ? '<span style="color:#ef4444;">*</span>' : '';
                    const reqAttr = field.required ? 'required' : '';

                    html += `<div class="i9-form-group">`;
                    html += `<label>${field.label} ${reqHtml}</label>`;
                    html += `<input type="${field.type}" name="${field.name}" class="i9-input" ${reqAttr} />`;
                    html += `</div>`;
                });
            }

            // Note: Per our plan (I9_attachment_to_view:001), we are skipping the file upload block for now.
            html += `<button type="submit" class="i9-btn-next">Submit & Verify Section 1 &rarr;</button>`;
            html += `</form></div></div>`;

            canvasEl.innerHTML = html;

            document.getElementById('dynamic-i9-form').addEventListener('submit', function (e) {
                e.preventDefault();
                alert("Section 1 data captured securely. Ready for Phase 5 (Validation & Document Vault).");
            });
        }

        // Add an isInit flag to send a hidden message
        async function handleSend(isInit = false) {
            let text = "";
            
            if (isInit) {
                text = "INIT_CONVERSATION"; // The hidden trigger
            } else {
                text = msgEl.value.trim();
                if (!text) return;
                addMsg("You", text);
                msgEl.value = "";
                // Save visible messages to history
                chatHistory.push({ role: "user", content: text });
            }

            const loadId = showLoading();
            statusEl.textContent = isInit ? "Connecting to HR..." : "Evaluating Policy...";

            // Prepare the payload (we don't push INIT_CONVERSATION to the visible chat history array)
            const payloadHistory = isInit ? [] : [...chatHistory];

            try {
                const res = await fetch("http://localhost:8001/api/chat/employee", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        session_id: sessionId,
                        message: text,
                        history: payloadHistory
                    }),
                });

                const reader = res.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let buffer = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    let boundary = buffer.indexOf('\n\n');

                    while (boundary !== -1) {
                        const chunk = buffer.slice(0, boundary).trim();
                        buffer = buffer.slice(boundary + 2);
                        boundary = buffer.indexOf('\n\n');

                        if (chunk.startsWith("data: ")) {
                            try {
                                const parsed = JSON.parse(chunk.slice(6)); 
                                
                                if (parsed.type === "result") {
                                    document.getElementById(loadId)?.remove();
                                    
                                    if (parsed.content.narration) {
                                        addMsg("System", parsed.content.narration, parsed.content.intent);
                                        chatHistory.push({ role: "assistant", content: parsed.content.narration });
                                    }

                                    console.log("Current Legal State:", parsed.content.current_state);

                                    if (parsed.content.intent === "FORM_READY" && parsed.content.artifacts) {
                                        renderForm(parsed.content.artifacts.dynamic_form);
                                    } else {
                                        statusEl.textContent = "Awaiting Discovery...";
                                    }
                                } else if (parsed.type === "error") {
                                    document.getElementById(loadId)?.remove();
                                    addMsg("System", "Backend Alert: " + parsed.content);
                                    statusEl.textContent = "Validation Failed";
                                }
                            } catch (e) { 
                                console.error("Stream parse error. Fragment received:", chunk, e);
                            }
                        }
                    }
                }
            } catch (err) {
                document.getElementById(loadId)?.remove();
                addMsg("System", "Error: " + err.message);
                statusEl.textContent = "Error";
            }
        }

        sendBtn.addEventListener("click", () => handleSend(false));
        msgEl.addEventListener("keydown", (e) => { if (e.key === "Enter") handleSend(false); });

        // TRIGGER AUTOMATICALLY ON PAGE LOAD
        window.addEventListener('DOMContentLoaded', () => handleSend(true));
    </script>
</body>

</html>